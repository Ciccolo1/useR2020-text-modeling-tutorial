<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Predictive modeling with text using tidy data principles</title>
    <meta charset="utf-8" />
    <meta name="author" content="Julia Silge &amp; Emil Hvitfeldt" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/font-awesome-5.3.1/css/fontawesome-all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, title-slide

# Predictive modeling with text using tidy data principles
## useR2020
### Julia Silge &amp; Emil Hvitfeldt
### 2019-7-24

---









class: center, middle

# Hello!

.pull-left[
&lt;img style="border-radius: 50%;" src="https://github.com/EmilHvitfeldt.png" width="150px"/&gt;  
[<i class="fab  fa-github "></i> @EmilHvitfeldt](https://github.com/EmilHvitfeldt)  
[<i class="fab  fa-twitter "></i> @Emil_Hvitfeldt](https://twitter.com/Emil_Hvitfeldt)  
[<i class="fas  fa-link "></i> hvitfeldt.me](https://www.hvitfeldt.me/)
]

.pull-right[
&lt;img style="border-radius: 50%;" src="https://github.com/juliasilge.png" width="150px"/&gt;  
[<i class="fab  fa-github "></i> @juliasilge](https://github.com/juliasilge)  
[<i class="fab  fa-twitter "></i> @juliasilge](https://twitter.com/juliasilge)  
[<i class="fas  fa-link "></i> juliasilge.com](https://juliasilge.com)
]
---

# Plan for today

--

- We will walk through our case study using slides and live coding



--


- After the tutorial, use the [materials on GitHub](https://github.com/EmilHvitfeldt/useR2020-text-modeling-tutorial) and YouTube recording to run the code yourself ðŸ’ª

---

# Text as data

Let's look at complaints submitted to the [United States Consumer Financial Protection Bureau (CFPB)](https://www.consumerfinance.gov/data-research/consumer-complaints/).


```r
library(tidyverse)

complaints &lt;- read_csv("data/complaints.csv.gz") %&gt;% sample_frac(0.005)
names(complaints)
```

```
##  [1] "date_received"                "product"                     
##  [3] "sub_product"                  "issue"                       
##  [5] "sub_issue"                    "consumer_complaint_narrative"
##  [7] "company_public_response"      "company"                     
##  [9] "state"                        "zip_code"                    
## [11] "tags"                         "consumer_consent_provided"   
## [13] "submitted_via"                "date_sent_to_company"        
## [15] "company_response_to_consumer" "timely_response"             
## [17] "consumer_disputed"            "complaint_id"
```

---

# Text as data


```r
complaints %&gt;%
  sample_n(10) %&gt;%
  pull(consumer_complaint_narrative)
```

```
##  [1] "On XX/XX/2018 I applied for an Ally Bank credit card. On XX/XX/2018 XXXX XXXX accessed my XXXX credit bureau report. \n\nSubsequently XXXX XXXX sent me a letter purporting to be an Adverse Action / ECOA Notice. This notice, required by law, must describe the real and actually reasons why my application was denied. Instead, Ally Bank subtitled untruthful, fraudulent reasons. \n\nXXXX XXXX simply regurgitated word for word the four factors that FICO Score uses when describing why one 's credit score is not higher than it actually is. \n\nFor example, FICO stated my credit score was only XXXX because : Lack of recent installment loan information XXXX XXXX stated my application was denied because : Lack of recent installment loan information XXXX XXXX 's actions do not comply with the law."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
##  [2] "THIS ACCOUNT DOES NOT BELONG TO ME AND I WOULD LIKE IT TO BE REMOVED FROM MY CREDIT REPORT."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
##  [3] "XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX, MO. XXXX XX/XX/XXXX RE : Navient Account Dispute To Whom It May Concern : My name is XXXX XXXX and I had a private student with Navient. It originated in XX/XX/XXXX and became default on XX/XX/XXXX. XX/XX/XXXX, I became disabled due to XXXX XXXX XXXX. When I learned about my disability I immediately informed Navient. They did not offer any resolution, so my account continued to accrue additional fees. It was charged off on XX/XX/XXXX and sent to XXXX XXXX XXXX  in Illinois. \n\nI called both Navient and XXXX XXXX XXXX today and was immediately given the run around. I called Navient to see if the statute of limitation had expired on my loan and was immediately put on hold. When they returned they immediately referred me to XXXX XXXX XXXX and the credit bureaus. \n\nBelow are the detailed summary of each interaction with each Navient and XXXX XXXX XXXX customer service representatives that occurred today. \n\nCalled XXXX XXXX XXXX and spoke to XXXX at XXXX XXXX and he refused to give me the status of the statute of limitation on my loan and referred me back to Navient to get that information. \n\nCalled Navient and spoke with XXXX at XXXX XXXX and she refused to give me the status of the statute of limitations on my loan and said that the credit bureaus would be the ones who could remove it from my credit report and provide the status of my statute of limitation on my loan. \n\nCalled Navient at XXXX and the rep referred me to the credit bear urea and refused to give me the status of the statute of limitation on my loan Called Navient and spoke to XXXX at XXXX who refused to give me the information that I was asking for, after pressuring he said the statute of limitation on this account was not active, but it will be as of XX/XX/XXXX. It was charged off on XX/XX/XXXX and its 7 years after that delinquent date. So, I decided to call back to verify that information and was told the following below. \n\nCalled Navient and spoke with XXXX at XXXX XXXX who referred me back to the credit bureaus and refused to give me the status of the statute of limitation on my loan. \n\nCalled Navient and spoke with XXXX at XXXX XXXX and was told that the account is not a-part of the statute of limitations because its in Missouri. I pushed further and was put on a long hold. She came back and asked me if I have spoken to the state of Missouri. I told her I have and questioned why was she inquiring about that, rather than providing the information that I requested. \n\nNavient and their treacherous acts and policies are causing borrowers like myself a whole world of credit problems. My loan should be removed from my credit report since the statute of limitation has passed. This account is over 10 years old and they are still reporting on my credit report that I am late. As I told Navient and the collection agency that has the loan now. I am currently getting social security because of my disability. Can you lease assist me with get the true status of the statute of limitations for my loan. The XXXX XXXX XXXX account number is XXXX. \n\nThank, XXXX XXXX XXXX"
##  [4] "Multiple Hard Inquiries were made without my consent or incorrect dates and followed credit bureau instructions to reach the lenders but they havent been able to help."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
##  [5] "I've reached out to XXXX XXXX on two separate occasions requesting lawful information under the Fair Credit Billing act. All letters were sent via priority mail with tracking. All requests were received by XXXX 'S Credit Dept, yet ignored. These are clear violations of the Fair Credit Billing Act. The interesting part is that I've disputed this account with all three credit bureaus on multiple occasions and the bureaus \" claim '' that XXXX XXXX responds to them and verifies the account. It's become very clear that the information I'm requesting no longer exist with XXXX XXXX. \n\nAfter sending letters to the original creditor and not getting a response I decided to dispute it with Transunion, XXXX  and XXXX. I've even sent them a copy of the letters sent to XXXX XXXX and asked them to remove the data but they have also ignored my request. The bureaus can clearly see that I've put forth effort to reach the original creditor for verification/documentation but they decide to leave it on my credit file. The bureaus are violating the FCRA by allowing this data unverified data to be reported. \n\nI've attached all correspondence sent to XXXX XXXX, including my most recent letter dated XX/XX/2019 which is being mailed out today. Delivery confirmation of previous letters is also attached."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
##  [6] "Last year I had to move. I didnt have the money to move so I went to the title loan company. I got {$1500.00} from them. I ran into issues and was having problems paying so I had to refinance. Which of course they screwed me over even more. They told me on a {$1500.00} loan that it would cost {$6000.00} to pay them back. Fast forward to now. They repossessed my only vehicle Saturday XX/XX/2019. Without warning. I also havent recieved a phone call from them in over a month. Nor have a I revived a call about them wanting to repossess my vehicle. The vehicle is my only mode of transportation. It has all of my tools and work material in it. They are refusing to tell me where the truck is so I can get all of my tools. And they are refusing to work with me. Saying they need a minimum of {$1200.00} up front just to release the truck. I have worked less than 40 hours this year and have no way to pay that kind of money. I cant even pay rent this month let alone pay {$1200.00} to a company that is in it to XXXX people over. I need my vehicle back as soon as possible so I can start to pay them back. I cant pay them back without the vehicle because I can not get to work."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
##  [7] "As of XX/XX/XXXX we ran our credit card bill up. We owed {$1400.00} on the XX/XX/XXXX statement. During XX/XX/XXXX I made these payments : XX/XX/XXXX {$2000.00} XX/XX/XXXX {$240.00} and XX/XX/XXXX $ XXXX.The payment date for the XXXX statement was XX/XX/XXXX. The new balance for XXXX was {$4300.00} with a payment due date of XX/XX/XXXX. I made a payment on XX/XX/XXXX for {$2500.00} that is not showing on this statement because no payments were showing but I paid the {$2500.00} before the due date. I did not pay this month in full and accrued interest of {$45.00} which I do not debate. Then in XXXX my amount owed was {$370.00} with a due date of XX/XX/XXXX. I paid XX/XX/XXXX {$130.00} XX/XX/XXXX {$2500.00} and XX/XX/XXXX {$5700.00}. I paid all purchases besides the pending purchases which were the {$370.00} before the credit card close date. I accrued interest which I disputed of {$75.00}. I was told by TWO citi representatives if I pay the credit card off full in two consecutive months, then the interest would stop accruing. So on XX/XX/XXXX I paid XXXX, XX/XX/XXXX XXXX and XX/XX/XXXX XXXX as the purchases posted. Then on XX/XX/XXXX I paid the remaining posted purchases of {$820.00} before the credit card close date and YET they still charged me interest of {$6.00}. I contacted them again and because my XXXX has a remaining statement balance it was not considered \" paid in full. '' I have never had a credit card company that required me pay two consecutive months to stop interest or have I ever had a credit card charge me interest when I have paid the credit card down to a XXXX balance beside pending purchases. I am a XXXX member and when they switched from XXXX XXXX, we had no say. There was no paperwork we signed. To get a copy of the card agreement you have to request it. This is by far the worst credit card I have ever had. Citi does not allow customers to pay pending purchases online and XXXX XXXX allowed me to. I could eliminate some stress if it allowed me to pay pending purchases but they are using this as leverage to charge interest to customers.I don't see how a credit card company can charge interest when the card was paid in full."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
##  [8] "Over the past few weeks we have received several robocalls from phone number XXXX. The recorded message says it is from XXXX and XXXX, that they are debt collectors,  and that we should call XXXX. The message does not give any indication of what this is about. We have no overdue bills."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
##  [9] "Experian Re : Chapter XXXX Bankruptcy To Whom It May Concern : I am disturbed that you continue to list the dismissed bankruptcy as confirmed within my crediti file. Although it is your policy to keep reporting bankruptcies that are filed, dismissed or adjudicated for ten years, the Fair credit Reporting Act mentions nothing in Section 1681c relating to bankruptcy about dismissals or filings. The law clearly states from \" date of adjudication '' or date of \" order of relief ''. Any case, civil or otherwise, which is dismissed no longer exists in the eye of the law and a case filed may never have actually been adjudicated. Therefore, you have no right to maintain information which the government has deemed nonexistent. Therefore, pursuant to Section 1681 ( a ) ( 5 ) of the FCRA, you must delete this information from my credit report and send me an updated copy when this action is completed. Considering that this does not require an investigation, I would appreciate your response within 14 calendar days from receipt of this letter. Again I never paid or walked into court for such a matter and by law it does not exists"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
## [10] "Several disputes has been filed to have this item removed from my credit file. I never opened an account with XXXX or XXXX XXXX XXXX. \nDates disputes has been filed with credit bureaus regarding this company was on XX/XX/XXXX, XX/XX/XXXX, and XX/XX/XXXX. And this account still has not been removed from my credit file. I don't even use my credit for anything, I have a nothing on my credit file. I'm a XXXX year old XXXX XXXX, that don't even understand how to use my credit. Therefore, this account can't possibly belong to me."
```

---

# Modeling Packages


```r
library(tidymodels)
library(textrecipes)
```

- [tidymodels](https://www.tidymodels.org/) is a collection of packages for modeling and machine learning using tidyverse principles.
- [textrecipes](https://textrecipes.tidymodels.org/) extends the recipes package to be able to handle text preprocessing.

---

# Modeling workflow

![](https://rviews.rstudio.com/post/2019-06-14-a-gentle-intro-to-tidymodels_files/figure-html/tidymodels.png)

---

# Class imbalance

&lt;img src="index_files/figure-html/unnamed-chunk-7-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

class: inverse

## We will simplify the task by turning it into a binary classification task

---

# Splitting


```r
set.seed(1234)

credit &lt;- "Credit reporting, credit repair services, or other personal consumer reports"

complaints2class &lt;- complaints %&gt;%
  mutate(product = factor(if_else(
    condition = product == credit, 
    true = "Credit", 
    false = "Other"))) %&gt;%
  rename(text = consumer_complaint_narrative)

complaints_split &lt;- initial_split(complaints2class, strata = product)

complaints_train &lt;- training(complaints_split)
complaints_test &lt;- testing(complaints_split)
```

---

# What variables can we use


```r
names(complaints_train)
```

```
##  [1] "date_received"                "product"                     
##  [3] "sub_product"                  "issue"                       
##  [5] "sub_issue"                    "text"                        
##  [7] "company_public_response"      "company"                     
##  [9] "state"                        "zip_code"                    
## [11] "tags"                         "consumer_consent_provided"   
## [13] "submitted_via"                "date_sent_to_company"        
## [15] "company_response_to_consumer" "timely_response"             
## [17] "consumer_disputed"            "complaint_id"
```

---

# Variable selecition checklist:

- Are we ethically allowed to use this variable?
- Are we legally allowed to use this variable?
- Would this variable be available to us at prediction time?
- Would this variable add more signal then noise?
- Would this variable to explainable?

---

TODO: 

talk about which variables fall into which catagory

zipcode would be clearly in catagory 1.

We end up using: date_received + tags + consumer_complaint_narrative

---

# Preprocessing specification


```r
complaints_rec &lt;-
  recipe(product ~ date_received + tags + text,
    data = complaints_train
  ) %&gt;%
  step_date(date_received, features = c("month", "dow"), role = "dates") %&gt;%
  step_rm(date_received) %&gt;%
  step_dummy(has_role("dates")) %&gt;%
  step_unknown(tags) %&gt;%
  step_dummy(tags) %&gt;%
  step_tokenize(text) %&gt;%
  step_stopwords(text) %&gt;%
  step_ngram(text, num_tokens = 3, min_num_tokens = 1) %&gt;%
  step_tokenfilter(text, max_tokens = tune(), min_times = 250) %&gt;%
  step_tfidf(text)
```

---

TODO:

talk about preprocessing step by step


---

# Let's talk about stopwords!

---


# Model specification


```r
svm_spec &lt;- svm_rbf() %&gt;%
  set_mode("classification") %&gt;%
  set_engine("liquidSVM")

svm_spec
```

```
## Radial Basis Function Support Vector Machine Specification (classification)
## 
## Computational engine: liquidSVM
```

---

# Creating a workflow


```r
wf_spec &lt;- workflow() %&gt;%
  add_recipe(complaints_rec) %&gt;%
  add_model(svm_spec)
```

---

# Setting up a tuning grid


```r
param_grid &lt;- grid_regular(max_tokens(range = c(500, 2000)),
  levels = 5
)

param_grid
```

```
## # A tibble: 5 x 1
##   max_tokens
##        &lt;int&gt;
## 1        500
## 2        875
## 3       1250
## 4       1625
## 5       2000
```

---



```r
complaints_folds &lt;- vfold_cv(complaints_train, v = 2)

complaints_folds
```

```
## #  2-fold cross-validation 
## # A tibble: 2 x 2
##   splits            id   
##   &lt;list&gt;            &lt;chr&gt;
## 1 &lt;split [220/220]&gt; Fold1
## 2 &lt;split [220/220]&gt; Fold2
```

---


```r
set.seed(42)
lasso_grid &lt;- tune_grid(
  wf_spec,
  resamples = complaints_folds,
  metrics = metric_set(accuracy, sensitivity, specificity),
  grid = param_grid,control = control_grid(verbose = TRUE)
) 
```

```
## i Fold1: recipe 1/5
```

```
## ! Fold1: recipe 1/5: max_features was set to '500', but only 9 was avail...
```

```
## âœ“ Fold1: recipe 1/5
```

```
## i Fold1: recipe 1/5, model 1/1
```

```
## ! Fold1: recipe 1/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold1: recipe 1/5, model 1/1
```

```
## i Fold1: recipe 1/5, model 1/1 (predictions)
```

```
## i Fold1: recipe 2/5
```

```
## ! Fold1: recipe 2/5: max_features was set to '875', but only 9 was avail...
```

```
## âœ“ Fold1: recipe 2/5
```

```
## i Fold1: recipe 2/5, model 1/1
```

```
## ! Fold1: recipe 2/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold1: recipe 2/5, model 1/1
```

```
## i Fold1: recipe 2/5, model 1/1 (predictions)
```

```
## i Fold1: recipe 3/5
```

```
## ! Fold1: recipe 3/5: max_features was set to '1250', but only 9 was avai...
```

```
## âœ“ Fold1: recipe 3/5
```

```
## i Fold1: recipe 3/5, model 1/1
```

```
## ! Fold1: recipe 3/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold1: recipe 3/5, model 1/1
```

```
## i Fold1: recipe 3/5, model 1/1 (predictions)
```

```
## i Fold1: recipe 4/5
```

```
## ! Fold1: recipe 4/5: max_features was set to '1625', but only 9 was avai...
```

```
## âœ“ Fold1: recipe 4/5
```

```
## i Fold1: recipe 4/5, model 1/1
```

```
## ! Fold1: recipe 4/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold1: recipe 4/5, model 1/1
```

```
## i Fold1: recipe 4/5, model 1/1 (predictions)
```

```
## i Fold1: recipe 5/5
```

```
## ! Fold1: recipe 5/5: max_features was set to '2000', but only 9 was avai...
```

```
## âœ“ Fold1: recipe 5/5
```

```
## i Fold1: recipe 5/5, model 1/1
```

```
## ! Fold1: recipe 5/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold1: recipe 5/5, model 1/1
```

```
## i Fold1: recipe 5/5, model 1/1 (predictions)
```

```
## i Fold2: recipe 1/5
```

```
## ! Fold2: recipe 1/5: max_features was set to '500', but only 7 was avail...
```

```
## âœ“ Fold2: recipe 1/5
```

```
## i Fold2: recipe 1/5, model 1/1
```

```
## ! Fold2: recipe 1/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold2: recipe 1/5, model 1/1
```

```
## i Fold2: recipe 1/5, model 1/1 (predictions)
```

```
## i Fold2: recipe 2/5
```

```
## ! Fold2: recipe 2/5: max_features was set to '875', but only 7 was avail...
```

```
## âœ“ Fold2: recipe 2/5
```

```
## i Fold2: recipe 2/5, model 1/1
```

```
## ! Fold2: recipe 2/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold2: recipe 2/5, model 1/1
```

```
## i Fold2: recipe 2/5, model 1/1 (predictions)
```

```
## i Fold2: recipe 3/5
```

```
## ! Fold2: recipe 3/5: max_features was set to '1250', but only 7 was avai...
```

```
## âœ“ Fold2: recipe 3/5
```

```
## i Fold2: recipe 3/5, model 1/1
```

```
## ! Fold2: recipe 3/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold2: recipe 3/5, model 1/1
```

```
## i Fold2: recipe 3/5, model 1/1 (predictions)
```

```
## i Fold2: recipe 4/5
```

```
## ! Fold2: recipe 4/5: max_features was set to '1625', but only 7 was avai...
```

```
## âœ“ Fold2: recipe 4/5
```

```
## i Fold2: recipe 4/5, model 1/1
```

```
## ! Fold2: recipe 4/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold2: recipe 4/5, model 1/1
```

```
## i Fold2: recipe 4/5, model 1/1 (predictions)
```

```
## i Fold2: recipe 5/5
```

```
## ! Fold2: recipe 5/5: max_features was set to '2000', but only 7 was avai...
```

```
## âœ“ Fold2: recipe 5/5
```

```
## i Fold2: recipe 5/5, model 1/1
```

```
## ! Fold2: recipe 5/5, model 1/1: Solution may not be optimal: try trainin...
```

```
## âœ“ Fold2: recipe 5/5, model 1/1
```

```
## i Fold2: recipe 5/5, model 1/1 (predictions)
```

---

# lets talk about tokenization

(this feels like an okay segway since using n-grams)

---

# Looking at the hyperparameters


```r
autoplot(lasso_grid)
```

&lt;img src="index_files/figure-html/unnamed-chunk-16-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

# Looking at the hyperparameters


```r
lasso_grid %&gt;%
  show_best("accuracy")
```

```
## # A tibble: 5 x 7
##   max_tokens .metric  .estimator  mean     n std_err .config
##        &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  
## 1        500 accuracy binary     0.609     2 0.00455 Recipe1
## 2        875 accuracy binary     0.609     2 0.00455 Recipe2
## 3       1250 accuracy binary     0.609     2 0.00455 Recipe3
## 4       1625 accuracy binary     0.609     2 0.00455 Recipe4
## 5       2000 accuracy binary     0.609     2 0.00455 Recipe5
```

---

# update workflow


```r
wf_spec_final &lt;- wf_spec %&gt;%
  finalize_workflow(parameters = select_best(lasso_grid, "accuracy"))
```

---

# Final fit


```r
final_fit &lt;- last_fit(object = wf_spec_final, 
                      split = complaints_split, 
                      metrics = metric_set(accuracy))
```

```
## ! Resample1: recipe: max_features was set to '500', but only 15 was availabl...
```

```
## ! Resample1: model: Solution may not be optimal: try training again using mi...
```


```r
final_fit %&gt;%
  collect_predictions() %&gt;%
  conf_mat(product, .pred_class)
```

```
##           Truth
## Prediction Credit Other
##     Credit     43    23
##     Other      28    52
```
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="macros.js"></script>
<script>var slideshow = remark.create({
"highlightLanguage": "r",
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
