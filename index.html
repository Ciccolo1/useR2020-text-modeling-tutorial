<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Predictive modeling with text using tidy data principles</title>
    <meta charset="utf-8" />
    <meta name="author" content="Julia Silge &amp; Emil Hvitfeldt" />
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/font-awesome-5.3.1/css/fontawesome-all.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="theme.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, title-slide

# Predictive modeling with text using tidy data principles
## useR2020
### Julia Silge &amp; Emil Hvitfeldt
### 2019-7-24

---









class: center, middle

# Hello!

.pull-left[
&lt;img style="border-radius: 50%;" src="https://github.com/EmilHvitfeldt.png" width="150px"/&gt;  
[<i class="fab  fa-github "></i> @EmilHvitfeldt](https://github.com/EmilHvitfeldt)  
[<i class="fab  fa-twitter "></i> @Emil_Hvitfeldt](https://twitter.com/Emil_Hvitfeldt)  
[<i class="fas  fa-link "></i> hvitfeldt.me](https://www.hvitfeldt.me/)
]

.pull-right[
&lt;img style="border-radius: 50%;" src="https://github.com/juliasilge.png" width="150px"/&gt;  
[<i class="fab  fa-github "></i> @juliasilge](https://github.com/juliasilge)  
[<i class="fab  fa-twitter "></i> @juliasilge](https://twitter.com/juliasilge)  
[<i class="fas  fa-link "></i> juliasilge.com](https://juliasilge.com)
]

---

# Plan for today

--

- We will walk through our case study using slides and live coding



--


- After the tutorial, use the [materials on GitHub](https://github.com/EmilHvitfeldt/useR2020-text-modeling-tutorial) and YouTube recording to run the code yourself 💪

---

# Text as data

Let's look at complaints submitted to the [United States Consumer Financial Protection Bureau (CFPB)](https://www.consumerfinance.gov/data-research/consumer-complaints/).

--


- An individual experiences a problem 😩 with a consumer financial product or service, like a bank, loan, or credit card 💰


--


- They submit a **complaint** to the CFPB explaining what happened 😡


--


- This complaint is sent to the company, which can respond or dispute


---

# Text as data

Let's look at complaints submitted to the [United States Consumer Financial Protection Bureau (CFPB)](https://www.consumerfinance.gov/data-research/consumer-complaints/).


```r
library(tidyverse)

complaints &lt;- read_csv("data/complaints.csv.gz") %&gt;% sample_frac(0.005)
names(complaints)
```

```
##  [1] "date_received"                "product"                     
##  [3] "sub_product"                  "issue"                       
##  [5] "sub_issue"                    "consumer_complaint_narrative"
##  [7] "company_public_response"      "company"                     
##  [9] "state"                        "zip_code"                    
## [11] "tags"                         "consumer_consent_provided"   
## [13] "submitted_via"                "date_sent_to_company"        
## [15] "company_response_to_consumer" "timely_response"             
## [17] "consumer_disputed"            "complaint_id"
```

---

# Text as data


```r
complaints %&gt;%
  sample_n(10) %&gt;%
  pull(consumer_complaint_narrative)
```

```
##  [1] "On XX/XX/2018 I applied for an Ally Bank credit card. On XX/XX/2018 XXXX XXXX accessed my XXXX credit bureau report. \n\nSubsequently XXXX XXXX sent me a letter purporting to be an Adverse Action / ECOA Notice. This notice, required by law, must describe the real and actually reasons why my application was denied. Instead, Ally Bank subtitled untruthful, fraudulent reasons. \n\nXXXX XXXX simply regurgitated word for word the four factors that FICO Score uses when describing why one 's credit score is not higher than it actually is. \n\nFor example, FICO stated my credit score was only XXXX because : Lack of recent installment loan information XXXX XXXX stated my application was denied because : Lack of recent installment loan information XXXX XXXX 's actions do not comply with the law."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
##  [2] "THIS ACCOUNT DOES NOT BELONG TO ME AND I WOULD LIKE IT TO BE REMOVED FROM MY CREDIT REPORT."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
##  [3] "XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX XXXX, MO. XXXX XX/XX/XXXX RE : Navient Account Dispute To Whom It May Concern : My name is XXXX XXXX and I had a private student with Navient. It originated in XX/XX/XXXX and became default on XX/XX/XXXX. XX/XX/XXXX, I became disabled due to XXXX XXXX XXXX. When I learned about my disability I immediately informed Navient. They did not offer any resolution, so my account continued to accrue additional fees. It was charged off on XX/XX/XXXX and sent to XXXX XXXX XXXX  in Illinois. \n\nI called both Navient and XXXX XXXX XXXX today and was immediately given the run around. I called Navient to see if the statute of limitation had expired on my loan and was immediately put on hold. When they returned they immediately referred me to XXXX XXXX XXXX and the credit bureaus. \n\nBelow are the detailed summary of each interaction with each Navient and XXXX XXXX XXXX customer service representatives that occurred today. \n\nCalled XXXX XXXX XXXX and spoke to XXXX at XXXX XXXX and he refused to give me the status of the statute of limitation on my loan and referred me back to Navient to get that information. \n\nCalled Navient and spoke with XXXX at XXXX XXXX and she refused to give me the status of the statute of limitations on my loan and said that the credit bureaus would be the ones who could remove it from my credit report and provide the status of my statute of limitation on my loan. \n\nCalled Navient at XXXX and the rep referred me to the credit bear urea and refused to give me the status of the statute of limitation on my loan Called Navient and spoke to XXXX at XXXX who refused to give me the information that I was asking for, after pressuring he said the statute of limitation on this account was not active, but it will be as of XX/XX/XXXX. It was charged off on XX/XX/XXXX and its 7 years after that delinquent date. So, I decided to call back to verify that information and was told the following below. \n\nCalled Navient and spoke with XXXX at XXXX XXXX who referred me back to the credit bureaus and refused to give me the status of the statute of limitation on my loan. \n\nCalled Navient and spoke with XXXX at XXXX XXXX and was told that the account is not a-part of the statute of limitations because its in Missouri. I pushed further and was put on a long hold. She came back and asked me if I have spoken to the state of Missouri. I told her I have and questioned why was she inquiring about that, rather than providing the information that I requested. \n\nNavient and their treacherous acts and policies are causing borrowers like myself a whole world of credit problems. My loan should be removed from my credit report since the statute of limitation has passed. This account is over 10 years old and they are still reporting on my credit report that I am late. As I told Navient and the collection agency that has the loan now. I am currently getting social security because of my disability. Can you lease assist me with get the true status of the statute of limitations for my loan. The XXXX XXXX XXXX account number is XXXX. \n\nThank, XXXX XXXX XXXX"
##  [4] "Multiple Hard Inquiries were made without my consent or incorrect dates and followed credit bureau instructions to reach the lenders but they havent been able to help."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
##  [5] "I've reached out to XXXX XXXX on two separate occasions requesting lawful information under the Fair Credit Billing act. All letters were sent via priority mail with tracking. All requests were received by XXXX 'S Credit Dept, yet ignored. These are clear violations of the Fair Credit Billing Act. The interesting part is that I've disputed this account with all three credit bureaus on multiple occasions and the bureaus \" claim '' that XXXX XXXX responds to them and verifies the account. It's become very clear that the information I'm requesting no longer exist with XXXX XXXX. \n\nAfter sending letters to the original creditor and not getting a response I decided to dispute it with Transunion, XXXX  and XXXX. I've even sent them a copy of the letters sent to XXXX XXXX and asked them to remove the data but they have also ignored my request. The bureaus can clearly see that I've put forth effort to reach the original creditor for verification/documentation but they decide to leave it on my credit file. The bureaus are violating the FCRA by allowing this data unverified data to be reported. \n\nI've attached all correspondence sent to XXXX XXXX, including my most recent letter dated XX/XX/2019 which is being mailed out today. Delivery confirmation of previous letters is also attached."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
##  [6] "Last year I had to move. I didnt have the money to move so I went to the title loan company. I got {$1500.00} from them. I ran into issues and was having problems paying so I had to refinance. Which of course they screwed me over even more. They told me on a {$1500.00} loan that it would cost {$6000.00} to pay them back. Fast forward to now. They repossessed my only vehicle Saturday XX/XX/2019. Without warning. I also havent recieved a phone call from them in over a month. Nor have a I revived a call about them wanting to repossess my vehicle. The vehicle is my only mode of transportation. It has all of my tools and work material in it. They are refusing to tell me where the truck is so I can get all of my tools. And they are refusing to work with me. Saying they need a minimum of {$1200.00} up front just to release the truck. I have worked less than 40 hours this year and have no way to pay that kind of money. I cant even pay rent this month let alone pay {$1200.00} to a company that is in it to XXXX people over. I need my vehicle back as soon as possible so I can start to pay them back. I cant pay them back without the vehicle because I can not get to work."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
##  [7] "As of XX/XX/XXXX we ran our credit card bill up. We owed {$1400.00} on the XX/XX/XXXX statement. During XX/XX/XXXX I made these payments : XX/XX/XXXX {$2000.00} XX/XX/XXXX {$240.00} and XX/XX/XXXX $ XXXX.The payment date for the XXXX statement was XX/XX/XXXX. The new balance for XXXX was {$4300.00} with a payment due date of XX/XX/XXXX. I made a payment on XX/XX/XXXX for {$2500.00} that is not showing on this statement because no payments were showing but I paid the {$2500.00} before the due date. I did not pay this month in full and accrued interest of {$45.00} which I do not debate. Then in XXXX my amount owed was {$370.00} with a due date of XX/XX/XXXX. I paid XX/XX/XXXX {$130.00} XX/XX/XXXX {$2500.00} and XX/XX/XXXX {$5700.00}. I paid all purchases besides the pending purchases which were the {$370.00} before the credit card close date. I accrued interest which I disputed of {$75.00}. I was told by TWO citi representatives if I pay the credit card off full in two consecutive months, then the interest would stop accruing. So on XX/XX/XXXX I paid XXXX, XX/XX/XXXX XXXX and XX/XX/XXXX XXXX as the purchases posted. Then on XX/XX/XXXX I paid the remaining posted purchases of {$820.00} before the credit card close date and YET they still charged me interest of {$6.00}. I contacted them again and because my XXXX has a remaining statement balance it was not considered \" paid in full. '' I have never had a credit card company that required me pay two consecutive months to stop interest or have I ever had a credit card charge me interest when I have paid the credit card down to a XXXX balance beside pending purchases. I am a XXXX member and when they switched from XXXX XXXX, we had no say. There was no paperwork we signed. To get a copy of the card agreement you have to request it. This is by far the worst credit card I have ever had. Citi does not allow customers to pay pending purchases online and XXXX XXXX allowed me to. I could eliminate some stress if it allowed me to pay pending purchases but they are using this as leverage to charge interest to customers.I don't see how a credit card company can charge interest when the card was paid in full."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
##  [8] "Over the past few weeks we have received several robocalls from phone number XXXX. The recorded message says it is from XXXX and XXXX, that they are debt collectors,  and that we should call XXXX. The message does not give any indication of what this is about. We have no overdue bills."                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
##  [9] "Experian Re : Chapter XXXX Bankruptcy To Whom It May Concern : I am disturbed that you continue to list the dismissed bankruptcy as confirmed within my crediti file. Although it is your policy to keep reporting bankruptcies that are filed, dismissed or adjudicated for ten years, the Fair credit Reporting Act mentions nothing in Section 1681c relating to bankruptcy about dismissals or filings. The law clearly states from \" date of adjudication '' or date of \" order of relief ''. Any case, civil or otherwise, which is dismissed no longer exists in the eye of the law and a case filed may never have actually been adjudicated. Therefore, you have no right to maintain information which the government has deemed nonexistent. Therefore, pursuant to Section 1681 ( a ) ( 5 ) of the FCRA, you must delete this information from my credit report and send me an updated copy when this action is completed. Considering that this does not require an investigation, I would appreciate your response within 14 calendar days from receipt of this letter. Again I never paid or walked into court for such a matter and by law it does not exists"                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
## [10] "Several disputes has been filed to have this item removed from my credit file. I never opened an account with XXXX or XXXX XXXX XXXX. \nDates disputes has been filed with credit bureaus regarding this company was on XX/XX/XXXX, XX/XX/XXXX, and XX/XX/XXXX. And this account still has not been removed from my credit file. I don't even use my credit for anything, I have a nothing on my credit file. I'm a XXXX year old XXXX XXXX, that don't even understand how to use my credit. Therefore, this account can't possibly belong to me."
```

---

# Text as data


--

- Text like this can be used for **supervised** or **predictive** modeling


--


- We can build both regression and classification models with text data


--


- We can use the ways language exhibits organization to create features for modeling


---

# Modeling Packages


```r
library(tidymodels)
library(textrecipes)
```

- [tidymodels](https://www.tidymodels.org/) is a collection of packages for modeling and machine learning using tidyverse principles
- [textrecipes](https://textrecipes.tidymodels.org/) extends the recipes package to handle text preprocessing

---

# Modeling workflow

![](https://rviews.rstudio.com/post/2019-06-14-a-gentle-intro-to-tidymodels_files/figure-html/tidymodels.png)

---

# smltar.com

&lt;iframe src="https://smltar.com/" width="100%" height="400px"&gt;&lt;/iframe&gt;

---

# Class imbalance

&lt;img src="index_files/figure-html/unnamed-chunk-8-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

class: inverse, right, middle

# Let's approach this as a **binary classification task**

---

# Credit or not?


```r
credit &lt;- "Credit reporting, credit repair services, or other personal consumer reports"

complaints2class &lt;- complaints %&gt;%
  mutate(product = factor(if_else(
    condition = product == credit, 
    true = "Credit", 
    false = "Other"))) %&gt;%
  rename(text = consumer_complaint_narrative)
```

---

# Data splitting

The testing set is a precious resource which can be used only once

&lt;img src="index_files/figure-html/all-split-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

# Data splitting


```r
set.seed(1234)

complaints_split &lt;- initial_split(complaints2class, strata = product)

complaints_train &lt;- training(complaints_split)
complaints_test &lt;- testing(complaints_split)
```

---

# Which of these variables can we use?


```r
names(complaints_train)
```

```
##  [1] "date_received"                "product"                     
##  [3] "sub_product"                  "issue"                       
##  [5] "sub_issue"                    "text"                        
##  [7] "company_public_response"      "company"                     
##  [9] "state"                        "zip_code"                    
## [11] "tags"                         "consumer_consent_provided"   
## [13] "submitted_via"                "date_sent_to_company"        
## [15] "company_response_to_consumer" "timely_response"             
## [17] "consumer_disputed"            "complaint_id"
```

---

# Feature selection checklist

--


- Is it ethical to use this variable? (or even legal?)


--


- Will this variable be available at prediction time?


--


- Does this variable contribute to explainability?

---

# Which of these variables can we use?


```r
names(complaints_train)
```

```
##  [1] "date_received"                "product"                     
##  [3] "sub_product"                  "issue"                       
##  [5] "sub_issue"                    "text"                        
##  [7] "company_public_response"      "company"                     
##  [9] "state"                        "zip_code"                    
## [11] "tags"                         "consumer_consent_provided"   
## [13] "submitted_via"                "date_sent_to_company"        
## [15] "company_response_to_consumer" "timely_response"             
## [17] "consumer_disputed"            "complaint_id"
```

---

# Which of these variables can we use?

- `date_received`
- `tags`
- `consumer_complaint_narrative` == 📃

---

# Preprocessing specification


```r
complaints_rec &lt;-
  recipe(product ~ date_received + tags + text,
    data = complaints_train
  ) %&gt;%
  step_date(date_received, features = c("month", "dow"), role = "dates") %&gt;%
  step_rm(date_received) %&gt;%
  step_dummy(has_role("dates")) %&gt;%
  step_unknown(tags) %&gt;%
  step_dummy(tags) %&gt;%
  step_tokenize(text) %&gt;%
  step_stopwords(text) %&gt;%
  step_ngram(text, num_tokens = 3, min_num_tokens = 1) %&gt;%
  step_tokenfilter(text, max_tokens = tune(), min_times = 5) %&gt;%
  step_tfidf(text)
```

---

# Feature engineering


```r
complaints_rec &lt;-
  recipe(product ~ date_received + tags + text,
    data = complaints_train
  ) %&gt;%
  step_date(date_received, features = c("month", "dow"), role = "dates") %&gt;%
  step_rm(date_received) %&gt;%
  step_dummy(has_role("dates")) %&gt;%
  step_unknown(tags) %&gt;%
  step_dummy(tags) %&gt;%
  step_tokenize(text) %&gt;%
  step_stopwords(text) %&gt;%
  step_ngram(text, num_tokens = 3, min_num_tokens = 1) %&gt;%
  step_tokenfilter(text, max_tokens = tune(), min_times = 5) %&gt;%
  step_tfidf(text)
```

--

Also, what does `tune()` mean here? 🤔

---

class: inverse, right, middle

# You can **combine** text and non-text features in your model

---

# Feature engineering: handling dates


```r
recipe(product ~ date_received + tags + text,
    data = complaints_train
  ) %&gt;%
  step_date(date_received, features = c("month", "dow"), role = "dates") %&gt;%
  step_rm(date_received)
```

```
## Data Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          3
## 
## Operations:
## 
## Date features from date_received
## Delete terms date_received
```

---

# Feature engineering: categorical data


```r
recipe(product ~ date_received + tags + text,
    data = complaints_train
  ) %&gt;%
  step_unknown(tags) %&gt;%
  step_dummy(tags)
```

```
## Data Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          3
## 
## Operations:
## 
## Unknown factor level assignment for tags
## Dummy variables from tags
```

---

class: inverse, right, middle

# You can **combine** text and non-text features in your model


---

# Feature engineering: text


```r
recipe(product ~ date_received + tags + text,
    data = complaints_train
  ) %&gt;%
  step_tokenize(text) %&gt;%
  step_stopwords(text) %&gt;%
  step_ngram(text, num_tokens = 3, min_num_tokens = 1) %&gt;%
  step_tokenfilter(text, max_tokens = tune(), min_times = 5) %&gt;%
  step_tfidf(text)
```

---

# Feature engineering: text


```
## Data Recipe
## 
## Inputs:
## 
##       role #variables
##    outcome          1
##  predictor          3
## 
## Operations:
## 
## Tokenization for text
## Stop word removal for text
## ngramming for text
## Text filtering for text
## Term frequency-inverse document frequency with text
```


---

class: inverse, right, middle

# How do we create **features** from **natural language**?


---

# From natural language to ML features


```r
library(tidytext)

complaints_train %&gt;%
  unnest_tokens(word, text) %&gt;%
  anti_join(get_stopwords(), by = "word") %&gt;%
  count(complaint_id, word) %&gt;%
  bind_tf_idf(word, complaint_id, n) %&gt;%
  cast_dfm(complaint_id, word, tf_idf)
```

```
## Document-feature matrix of: 440 documents, 4,726 features (98.7% sparse).
```


---

class: inverse, center, middle

# 🛑 STOP WORDS 🛑

---

# Stop words


```r
library(stopwords)
stopwords()
```

```
##   [1] "i"          "me"         "my"         "myself"     "we"         "our"       
##   [7] "ours"       "ourselves"  "you"        "your"       "yours"      "yourself"  
##  [13] "yourselves" "he"         "him"        "his"        "himself"    "she"       
##  [19] "her"        "hers"       "herself"    "it"         "its"        "itself"    
##  [25] "they"       "them"       "their"      "theirs"     "themselves" "what"      
##  [31] "which"      "who"        "whom"       "this"       "that"       "these"     
##  [37] "those"      "am"         "is"         "are"        "was"        "were"      
##  [43] "be"         "been"       "being"      "have"       "has"        "had"       
##  [49] "having"     "do"         "does"       "did"        "doing"      "would"     
##  [55] "should"     "could"      "ought"      "i'm"        "you're"     "he's"      
##  [61] "she's"      "it's"       "we're"      "they're"    "i've"       "you've"    
##  [67] "we've"      "they've"    "i'd"        "you'd"      "he'd"       "she'd"     
##  [73] "we'd"       "they'd"     "i'll"       "you'll"     "he'll"      "she'll"    
##  [79] "we'll"      "they'll"    "isn't"      "aren't"     "wasn't"     "weren't"   
##  [85] "hasn't"     "haven't"    "hadn't"     "doesn't"    "don't"      "didn't"    
##  [91] "won't"      "wouldn't"   "shan't"     "shouldn't"  "can't"      "cannot"    
##  [97] "couldn't"   "mustn't"    "let's"      "that's"     "who's"      "what's"    
## [103] "here's"     "there's"    "when's"     "where's"    "why's"      "how's"     
## [109] "a"          "an"         "the"        "and"        "but"        "if"        
## [115] "or"         "because"    "as"         "until"      "while"      "of"        
## [121] "at"         "by"         "for"        "with"       "about"      "against"   
## [127] "between"    "into"       "through"    "during"     "before"     "after"     
## [133] "above"      "below"      "to"         "from"       "up"         "down"      
## [139] "in"         "out"        "on"         "off"        "over"       "under"     
## [145] "again"      "further"    "then"       "once"       "here"       "there"     
## [151] "when"       "where"      "why"        "how"        "all"        "any"       
## [157] "both"       "each"       "few"        "more"       "most"       "other"     
## [163] "some"       "such"       "no"         "nor"        "not"        "only"      
## [169] "own"        "same"       "so"         "than"       "too"        "very"      
## [175] "will"
```


---

class: center, middle

&lt;img src="index_files/figure-html/unnamed-chunk-21-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

# Stop words


--


- Stop words are context specific


--


- Stop word lexicons can have bias


--


- You can create your own stop word list


--


- See [Chapter 3](https://smltar.com/stopwords.html) for more! 🛑

---

class: inverse, right, middle

## What kind of **models** work well for text?

---

# Text models

Remember that text data is sparse! 😮

--


- Regularized linear models (glmnet)
- Support vector machines
- naive Bayes
- Tree-based models like random forest? 

---

# Text models

Remember that text data is sparse! 😮

- Regularized linear models (glmnet)
- Support vector machines
- naive Bayes
- Tree-based models like random forest?  🙅

---

class: inverse, right, middle

# Does text data have to be **sparse**?

---


&gt;### You shall know a word by the company it keeps.
#### [💬 John Rupert Firth](https://en.wikiquote.org/wiki/John_Rupert_Firth)



--

Learn more about word embeddings:

- in [Chapter 5](https://smltar.com/embeddings.html)
- at [juliasilge.github.io/why-r-webinar/](https://juliasilge.github.io/why-r-webinar/)


---

# To specify a model in tidymodels

1\. Pick a **model**

2\. Set the **mode** (if needed)

3\. Set the **engine**

---

background-image: url(https://github.com/allisonhorst/stats-illustrations/raw/master/rstats-artwork/parsnip.png)
background-size: cover

.footnote[
Art by [Allison Horst](https://github.com/allisonhorst/stats-illustrations)
]

---

# To specify a model in tidymodels

All available models are listed at &lt;https://tidymodels.org/find/parsnip&gt;

&lt;iframe src="https://tidymodels.org/find/parsnip" width="100%" height="400px"&gt;&lt;/iframe&gt;

---

class: middle


# `set_mode()`

Some models can solve multiple types of problems



```r
svm_rbf() %&gt;% set_mode(mode = "regression")
```

```
## Radial Basis Function Support Vector Machine Specification (regression)
```

---

class: middle


# `set_mode()`

Some models can solve multiple types of problems



```r
svm_rbf() %&gt;% set_mode(mode = "classification")
```

```
## Radial Basis Function Support Vector Machine Specification (classification)
```

---

class: middle


# `set_engine()`

The same model can be implemented by multiple computational engines



```r
svm_rbf() %&gt;% set_engine("kernlab")
```

```
## Radial Basis Function Support Vector Machine Specification (unknown)
## 
## Computational engine: kernlab
```

---

class: middle


# `set_engine()`

The same model can be implemented by multiple computational engines



```r
svm_rbf() %&gt;% set_engine("liquidSVM")
```

```
## Radial Basis Function Support Vector Machine Specification (unknown)
## 
## Computational engine: liquidSVM
```

---

# What makes a model?


```r
lasso_spec &lt;- logistic_reg(penalty = tune(), mixture = 1) %&gt;%
  set_mode("classification") %&gt;%
  set_engine("glmnet")


lasso_spec
```

```
## Logistic Regression Model Specification (classification)
## 
## Main Arguments:
##   penalty = tune()
##   mixture = 1
## 
## Computational engine: glmnet
```


--

It's `tune()` again! 😟

---

## Parameters and... hyperparameters?

- Some model parameters can be learned from data during fitting/training


--


- Some CANNOT 😱


--


- These are **hyperparameters** of a model, and we estimate them by training lots of models with different hyperparameters and comparing them


---

# A grid of possible hyperparameters


```r
param_grid &lt;- grid_regular(
  penalty(range = c(-4, 0)),
  max_tokens(range = c(500, 2000)),
  levels = 6
)
```


---

# A grid of possible hyperparameters


```
## # A tibble: 36 x 2
##     penalty max_tokens
##       &lt;dbl&gt;      &lt;int&gt;
##  1 0.0001          500
##  2 0.000631        500
##  3 0.00398         500
##  4 0.0251          500
##  5 0.158           500
##  6 1               500
##  7 0.0001          800
##  8 0.000631        800
##  9 0.00398         800
## 10 0.0251          800
## # … with 26 more rows
```

---

class: inverse, right, middle

# How can we **compare** and **evaluate** these different models?

---

background-image: url(https://www.tidymodels.org/start/resampling/img/resampling.svg)
background-size: 60%

---

# Spend your data budget


```r
set.seed(123)
complaints_folds &lt;- vfold_cv(complaints_train, v = 2, strata = product)

complaints_folds
```

```
## #  2-fold cross-validation using stratification 
## # A tibble: 2 x 2
##   splits            id   
##   &lt;list&gt;            &lt;chr&gt;
## 1 &lt;split [219/221]&gt; Fold1
## 2 &lt;split [221/219]&gt; Fold2
```

---
class: middle, center, inverse

# ✨ CROSS-VALIDATION ✨

---
background-image: url(images/cross-validation/Slide2.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide3.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide4.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide5.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide6.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide7.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide8.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide9.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide10.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---
background-image: url(images/cross-validation/Slide11.png)
background-size: contain

.footnote[
Art by [Alison Hill](https://alison.rbind.io/)
]
---

class: inverse, right, middle

# Spend your data wisely to create **simulated** validation sets

---

class: inverse, right, middle

# Now we have **resamples**, **features**, plus a **model**

---

# Create a workflow


```r
complaints_wf &lt;- workflow() %&gt;%
  add_recipe(complaints_rec) %&gt;%
  add_model(lasso_spec)
```

---

class: inverse, right, middle

# What is a `workflow()`?

---

## Time to tune! ⚡


```r
set.seed(42)
lasso_grid &lt;- tune_grid(
  complaints_wf,
  resamples = complaints_folds,
  grid = param_grid, 
  control = control_grid(save_pred = TRUE)
) 
```

---

## Time to tune! ⚡


```
## Warning: This tuning result has notes. Example notes on model fitting include:
## recipe 4/6: max_features was set to '1400', but only 1179 was available and selected.
## recipe 5/6: max_features was set to '1700', but only 1354 was available and selected.
## recipe 6/6: max_features was set to '2000', but only 1354 was available and selected.
```

```
## # Tuning results
## # 2-fold cross-validation using stratification 
## # A tibble: 2 x 5
##   splits            id    .metrics          .notes           .predictions        
##   &lt;list&gt;            &lt;chr&gt; &lt;list&gt;            &lt;list&gt;           &lt;list&gt;              
## 1 &lt;split [219/221]&gt; Fold1 &lt;tibble [72 × 6]&gt; &lt;tibble [3 × 1]&gt; &lt;tibble [7,956 × 8]&gt;
## 2 &lt;split [221/219]&gt; Fold2 &lt;tibble [72 × 6]&gt; &lt;tibble [3 × 1]&gt; &lt;tibble [7,884 × 8]&gt;
```

---
class: middle, center, inverse

# 💫 TOKENIZATION 💫

---

# Tokenization

- The process of splitting text in smaller pieces of text (_tokens_)


--


- Most common token == word, but sometimes we tokenize in a different way


--


- An essential part of most text analyses


--


- Many options to take into consideration 

---

# Tokenization: whitespace




```r
token_example
```

```
## [1] "I am a long-time victim of identity theft. This debt doesn't belong to me."
```

--


```r
strsplit(token_example, "\\s")
```

```
## [[1]]
##  [1] "I"         "am"        "a"         "long-time" "victim"    "of"        "identity" 
##  [8] "theft."    "This"      "debt"      "doesn't"   "belong"    "to"        "me."
```

---

# Tokenization: [tokenizers](https://docs.ropensci.org/tokenizers/) package



```r
token_example
```

```
## [1] "I am a long-time victim of identity theft. This debt doesn't belong to me."
```


```r
library(tokenizers)

tokenize_words(token_example)
```

```
## [[1]]
##  [1] "i"        "am"       "a"        "long"     "time"     "victim"   "of"       "identity"
##  [9] "theft"    "this"     "debt"     "doesn't"  "belong"   "to"       "me"
```

---

# Tokenization: [spaCy](https://spacy.io/) library



```r
token_example
```

```
## [1] "I am a long-time victim of identity theft. This debt doesn't belong to me."
```


```r
library(spacyr)

spacy_tokenize(token_example)
```


```
## [[1]]
##  [1] "I"        "am"       "a"        "long"     "-"        "time"     "victim"   "of"      
##  [9] "identity" "theft"    "."        "This"     "debt"     "does"     "n't"      "belong"  
## [17] "to"       "me"       "."
```

---

whitespace


```
## [[1]]
##  [1] "I"         "am"        "a"         "long-time" "victim"    "of"        "identity" 
##  [8] "theft."    "This"      "debt"      "doesn't"   "belong"    "to"        "me."
```

tokenizers package


```
## [[1]]
##  [1] "i"        "am"       "a"        "long"     "time"     "victim"   "of"       "identity"
##  [9] "theft"    "this"     "debt"     "doesn't"  "belong"   "to"       "me"
```

spaCy library


```
## [[1]]
##  [1] "I"        "am"       "a"        "long"     "-"        "time"     "victim"   "of"      
##  [9] "identity" "theft"    "."        "This"     "debt"     "does"     "n't"      "belong"  
## [17] "to"       "me"       "."
```

---

# Tokenization considerations

- Should we turn UPPERCASE letters to lowercase?


--


- How should we handle punctuation⁉️


--


- What about non-word characters _inside_ words?


--


- Should compound words be split or multi-word ideas be kept together?

---

class: inverse, right, middle

## Tokenization for English text is typically **much easier** than other languages.

---

# N-grams

## A sequence of `n` sequential tokens

--


- Captures words that appear together often


--


- Can detect negations ("not happy")


--


- Larger cardinality


---


```r
tokenize_ngrams(token_example, n = 1)
```

```
## [[1]]
##  [1] "i"        "am"       "a"        "long"     "time"     "victim"   "of"       "identity"
##  [9] "theft"    "this"     "debt"     "doesn't"  "belong"   "to"       "me"
```



```r
tokenize_ngrams(token_example, n = 2)
```

```
## [[1]]
##  [1] "i am"           "am a"           "a long"         "long time"      "time victim"   
##  [6] "victim of"      "of identity"    "identity theft" "theft this"     "this debt"     
## [11] "debt doesn't"   "doesn't belong" "belong to"      "to me"
```



```r
tokenize_ngrams(token_example, n = 3)
```

```
## [[1]]
##  [1] "i am a"              "am a long"           "a long time"         "long time victim"   
##  [5] "time victim of"      "victim of identity"  "of identity theft"   "identity theft this"
##  [9] "theft this debt"     "this debt doesn't"   "debt doesn't belong" "doesn't belong to"  
## [13] "belong to me"
```

---

# Tokenization

See [Chapter 2](https://smltar.com/tokenization.html) for more!

---

# Look at the tuning results 👀



```r
collect_metrics(lasso_grid)
```

```
## # A tibble: 72 x 8
##     penalty max_tokens .metric  .estimator  mean     n std_err .config       
##       &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;    &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;         
##  1 0.0001          500 accuracy binary     0.766     2 0.0194  Recipe1_Model1
##  2 0.0001          500 roc_auc  binary     0.850     2 0.0242  Recipe1_Model1
##  3 0.000631        500 accuracy binary     0.766     2 0.0194  Recipe1_Model2
##  4 0.000631        500 roc_auc  binary     0.850     2 0.0242  Recipe1_Model2
##  5 0.00398         500 accuracy binary     0.775     2 0.0149  Recipe1_Model3
##  6 0.00398         500 roc_auc  binary     0.853     2 0.0254  Recipe1_Model3
##  7 0.0251          500 accuracy binary     0.789     2 0.00323 Recipe1_Model4
##  8 0.0251          500 roc_auc  binary     0.877     2 0.00645 Recipe1_Model4
##  9 0.158           500 accuracy binary     0.625     2 0.00966 Recipe1_Model5
## 10 0.158           500 roc_auc  binary     0.747     2 0.0434  Recipe1_Model5
## # … with 62 more rows
```

---


```r
autoplot(lasso_grid)
```

&lt;img src="index_files/figure-html/unnamed-chunk-48-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

# Look at the tuning results 👀


```r
lasso_grid %&gt;%
  show_best("roc_auc")
```

```
## # A tibble: 5 x 8
##   penalty max_tokens .metric .estimator  mean     n std_err .config       
##     &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;         
## 1  0.0251       1400 roc_auc binary     0.892     2 0.00388 Recipe4_Model4
## 2  0.0251       1700 roc_auc binary     0.892     2 0.00388 Recipe5_Model4
## 3  0.0251       2000 roc_auc binary     0.892     2 0.00388 Recipe6_Model4
## 4  0.0251       1100 roc_auc binary     0.889     2 0.00593 Recipe3_Model4
## 5  0.0251        800 roc_auc binary     0.880     2 0.00486 Recipe2_Model4
```

---

# The **best** 🥇 hyperparameters 


```r
best_roc_auc &lt;- select_best(lasso_grid, "roc_auc")

best_roc_auc
```

```
## # A tibble: 1 x 3
##   penalty max_tokens .config       
##     &lt;dbl&gt;      &lt;int&gt; &lt;chr&gt;         
## 1  0.0251       1400 Recipe4_Model4
```

---

# Evaluate the best model 📐


```r
collect_predictions(lasso_grid, 
                    parameters = best_roc_auc)
```

```
## # A tibble: 440 x 9
##    id    .pred_Credit .pred_Other  .row max_tokens penalty .pred_class product .config       
##    &lt;chr&gt;        &lt;dbl&gt;       &lt;dbl&gt; &lt;int&gt;      &lt;int&gt;   &lt;dbl&gt; &lt;fct&gt;       &lt;fct&gt;   &lt;chr&gt;         
##  1 Fold1       0.586        0.414     2       1400  0.0251 Credit      Credit  Recipe4_Model4
##  2 Fold1       0.739        0.261     3       1400  0.0251 Credit      Credit  Recipe4_Model3
##  3 Fold1       0.107        0.893     4       1400  0.0251 Other       Other   Recipe4_Model2
##  4 Fold1       0.839        0.161     5       1400  0.0251 Credit      Credit  Recipe4_Model1
##  5 Fold1       0.396        0.604     7       1400  0.0251 Other       Other   Recipe4_Model6
##  6 Fold1       0.0991       0.901     9       1400  0.0251 Other       Credit  Recipe4_Model5
##  7 Fold1       0.295        0.705    10       1400  0.0251 Other       Other   Recipe4_Model4
##  8 Fold1       0.0778       0.922    11       1400  0.0251 Other       Other   Recipe4_Model3
##  9 Fold1       0.254        0.746    15       1400  0.0251 Other       Other   Recipe4_Model2
## 10 Fold1       0.732        0.268    18       1400  0.0251 Credit      Credit  Recipe4_Model1
## # … with 430 more rows
```

---

# Evaluate the best model 📐


```r
collect_predictions(lasso_grid, 
                    parameters = select_best(lasso_grid, "roc_auc")) %&gt;%
  group_by(id) %&gt;%
  roc_curve(truth = product, .pred_Credit) %&gt;%
  autoplot()
```

---

# Evaluate the best model 📐

&lt;img src="index_files/figure-html/unnamed-chunk-53-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

# Update the workflow

We can update our workflow with the best performing hyperparameters.


```r
wf_spec_final &lt;- wf_spec %&gt;%
  finalize_workflow(parameters = best_roc_auc)
```

This workflow is ready to go! It can now be applied to new data.

---

class: inverse, right, middle

# How is our model **thinking**?

---

## Variable importance


```r
wf_spec_final %&gt;%
  fit(complaints_train) %&gt;%
  pull_workflow_fit() %&gt;%
  vip::vi(lambda = select_best(lasso_grid, "roc_auc")$penalty) %&gt;%
  filter(!str_detect(Variable, "tfidf")) %&gt;%
  filter(Importance != 0)
```

```
## # A tibble: 4 x 3
##   Variable                Importance Sign 
##   &lt;chr&gt;                        &lt;dbl&gt; &lt;chr&gt;
## 1 date_received_month_Apr      1.03  POS  
## 2 date_received_month_Aug      0.515 POS  
## 3 tags_unknown                -0.174 NEG  
## 4 date_received_month_May     -0.329 NEG
```

---

## Variable importance


```r
wi_data &lt;- wf_spec_final %&gt;%
  fit(complaints_train) %&gt;%
  pull_workflow_fit() %&gt;%
  vip::vi(lambda = select_best(lasso_grid, "roc_auc")$penalty) %&gt;%
  mutate(Variable = str_remove_all(Variable, "tfidf_text_")) %&gt;%
  filter(Importance != 0)
```

---

## Variable importance 


```r
wi_data
```

```
## # A tibble: 227 x 3
##    Variable       Importance Sign 
##    &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt;
##  1 xx_xxxx_called       88.7 POS  
##  2 thru                 74.7 POS  
##  3 entity               65.4 POS  
##  4 contact              55.5 POS  
##  5 phone_calls          51.2 POS  
##  6 ask                  49.9 POS  
##  7 comply               49.6 POS  
##  8 stating              41.5 POS  
##  9 filed                36.9 POS  
## 10 refuse               36.6 POS  
## # … with 217 more rows
```

---

class: center, middle



&lt;img src="index_files/figure-html/unnamed-chunk-59-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

## Credit Complaint #1

&lt;span, style = 'color:green;'&gt;Credit&lt;/span&gt;
&lt;span, style = 'color:black;'&gt;And&lt;/span&gt;
&lt;span, style = 'color:blue;'&gt;Other&lt;/span&gt;

<div>
<span>i</span>
<span>have</span>
<span>contacted</span>
<span style="color:#39763E;">
<em>equifax</em>
</span>
<span>on</span>
<span>at</span>
<span>least</span>
<span>5</span>
<span>occasions</span>
<span>to</span>
<span>include</span>
<span>a</span>
<span>xxxx</span>
<span>xxxx</span>
<span style="color:#69A75F;">
<em>credit</em>
</span>
<span style="color:#2A406C;">
<em>card</em>
</span>
<span>on</span>
<span>my</span>
<span>profile</span>
<span>i</span>
<span>have</span>
<span>provided</span>
<span>photo</span>
<span>identification</span>
<span>my</span>
<span style="color:#19341B;">
<em>ss</em>
</span>
<span>and</span>
<span>a</span>
<span>copy</span>
<span>of</span>
<span>the</span>
<span style="color:#2A406C;">
<em>card</em>
</span>
<span>because</span>
<span>they</span>
<span>have</span>
<span>refused</span>
<span>to</span>
<span style="color:#26512A;">
<em>update</em>
</span>
<span>my</span>
<span>profile</span>
<span>my</span>
<span style="color:#69A75F;">
<em>credit</em>
</span>
<span style="color:#3E7E41;">
<em>score</em>
</span>
<span>remains</span>
<span>below</span>
<span>600</span>
<span>and</span>
<span>i</span>
<span>have</span>
<span>been</span>
<span>denied</span>
<span style="color:#69A75F;">
<em>credit</em>
</span>
<span>on</span>
<span style="color:#4363A2;">
<em>several</em>
</span>
<span>occasions</span>
<span>i</span>
<span>have</span>
<span>had</span>
<span>the</span>
<span style="color:#2A406C;">
<em>card</em>
</span>
<span>for</span>
<span>at</span>
<span>least</span>
<span style="color:#1F4423;">
<em>4</em>
</span>
<span>years</span>
<span>yet</span>
<span>my</span>
<span style="color:#69A75F;">
<em>credit</em>
</span>
<span>profile</span>
<span>with</span>
<span style="color:#39763E;">
<em>equifax</em>
</span>
<span>claims</span>
<span>i</span>
<span>have</span>
<span>no</span>
<span style="color:#69A75F;">
<em>credit</em>
</span>
<span>history</span>
<span>i</span>
<span>have</span>
<span>contacted</span>
<span>them</span>
<span>via</span>
<span>letters</span>
<span style="color:#0C1418;">
<em>online</em>
</span>
<span>disputes</span>
<span>and</span>
<span>telephone</span>
<span>to</span>
<span>no</span>
<span>avail</span>
<span>please</span>
<span>advise</span>
<span>as</span>
<span>to</span>
<span>other</span>
<span>remedies</span>
<span>available</span>
<span>to</span>
<span>me</span>
</div>

---

## Credit Complaint #2

&lt;span, style = 'color:green;'&gt;Credit&lt;/span&gt;
&lt;span, style = 'color:black;'&gt;And&lt;/span&gt;
&lt;span, style = 'color:blue;'&gt;Other&lt;/span&gt;

<div>
<span>i</span>
<span>have</span>
<span>disputed</span>
<span>items</span>
<span>with</span>
<span style="color:#39763E;">
<em>equifax</em>
</span>
<span>back</span>
<span>on</span>
<span>xx</span>
<span>xx</span>
<span>2019</span>
<span>and</span>
<span>they</span>
<span>have</span>
<span>failed</span>
<span>to</span>
<span>respond</span>
<span>i</span>
<span>have</span>
<span>also</span>
<span>sent</span>
<span>them</span>
<span>a</span>
<span style="color:#3E5E99;">
<em>notice</em>
</span>
<span>that</span>
<span>they</span>
<span>failed</span>
<span>to</span>
<span>respond</span>
<span>and</span>
<span>they</span>
<span>have</span>
<span>ignore</span>
<span>my</span>
<span>request</span>
<span>to</span>
<span style="color:#39773E;">
<em>dispute</em>
</span>
<span>items</span>
<span>that</span>
<span>are</span>
<span style="color:#1E3F20;">
<em>reporting</em>
</span>
<span>on</span>
<span>my</span>
<span style="color:#69A75F;">
<em>credit</em>
</span>
<span>reports</span>
</div>

---

## Other Complaint #1

&lt;span, style = 'color:green;'&gt;Credit&lt;/span&gt;
&lt;span, style = 'color:black;'&gt;And&lt;/span&gt;
&lt;span, style = 'color:blue;'&gt;Other&lt;/span&gt;

<div>
<span>i</span>
<span>was</span>
<span>contacted</span>
<span>on</span>
<span>xxxx</span>
<span>xx</span>
<span>xx</span>
<span>2019</span>
<span>by</span>
<span>portfolio</span>
<span style="color:#496AAB;">
<em>recovery</em>
</span>
<span>associates</span>
<span>about</span>
<span>a</span>
<span>past</span>
<span style="color:#1F2F4E;">
<em>debt</em>
</span>
<span>that</span>
<span>i</span>
<span>have</span>
<span>no</span>
<span>knowledge</span>
<span>of</span>
<span>having</span>
<span>the</span>
<span>representative</span>
<span>mentioned</span>
<span>that</span>
<span>there</span>
<span>was</span>
<span>an</span>
<span>attempt</span>
<span>to</span>
<span>deliver</span>
<span>paperwork</span>
<span>but</span>
<span>paperwork</span>
<span>delivery</span>
<span>was</span>
<span>at</span>
<span>a</span>
<span>different</span>
<span>location</span>
<span>that</span>
<span>my</span>
<span style="color:#132815;">
<em>physical</em>
</span>
<span>home</span>
<span>address</span>
<span>upon</span>
<span>requesting</span>
<span>further</span>
<span>clarification</span>
<span>the</span>
<span>representative</span>
<span>continued</span>
<span>to</span>
<span>say</span>
<span>how</span>
<span>i</span>
<span>was</span>
<span>refusing</span>
<span>to</span>
<span style="color:#95C077;">
<em>pay</em>
</span>
<span>the</span>
<span style="color:#1F2F4E;">
<em>debt</em>
</span>
<span>i</span>
<span style="color:#121927;">
<em>never</em>
</span>
<span>refused</span>
<span>to</span>
<span style="color:#95C077;">
<em>pay</em>
</span>
<span>the</span>
<span style="color:#1F2F4E;">
<em>debt</em>
</span>
<span>i</span>
<span>would</span>
<span>just</span>
<span>like</span>
<span>clarification</span>
<span>on</span>
<span>the</span>
<span style="color:#1F2F4E;">
<em>debt</em>
</span>
<span>i</span>
<span>will</span>
<span>be</span>
<span>delivering</span>
<span>a</span>
<span>cease</span>
<span>and</span>
<span>desist</span>
<span>order</span>
<span>to</span>
<span>the</span>
<span>aforementioned</span>
<span>party</span>
</div>

---

## Other Complaint #2

&lt;span, style = 'color:green;'&gt;Credit&lt;/span&gt;
&lt;span, style = 'color:black;'&gt;And&lt;/span&gt;
&lt;span, style = 'color:blue;'&gt;Other&lt;/span&gt;

<div>
<span>xxxx</span>
<span>xxxx</span>
<span>is</span>
<span>alleging</span>
<span>that</span>
<span>i</span>
<span>owe</span>
<span>them</span>
<span>690.00</span>
<span>i</span>
<span>did</span>
<span>not</span>
<span>breach</span>
<span>my</span>
<span>rental</span>
<span>contract</span>
<span>and</span>
<span>do</span>
<span>not</span>
<span style="color:#314B7C;">
<em>understand</em>
</span>
<span>the</span>
<span style="color:#2D6133;">
<em>charges</em>
</span>
<span>against</span>
<span>me</span>
<span>i</span>
<span>have</span>
<span style="color:#38548C;">
<em>attempted</em>
</span>
<span>to</span>
<span>resolve</span>
<span>the</span>
<span>matter</span>
<span>but</span>
<span>every</span>
<span>time</span>
<span>i</span>
<span>try</span>
<span>the</span>
<span>claim</span>
<span>that</span>
<span>i</span>
<span>owe</span>
<span>them</span>
<span>additional</span>
<span style="color:#2C4471;">
<em>monies</em>
</span>
<span>i</span>
<span>believe</span>
<span>that</span>
<span>i</span>
<span>am</span>
<span>a</span>
<span>victim</span>
<span>of</span>
<span>fraud</span>
<span>and</span>
<span>unfair</span>
<span>business</span>
<span>tactics</span>
<span>management</span>
<span>is</span>
<span>run</span>
<span>very</span>
<span>poorly</span>
<span>and</span>
<span>one</span>
<span style="color:#38743D;">
<em>person</em>
</span>
<span>says</span>
<span>one</span>
<span>thing</span>
<span>another</span>
<span>says</span>
<span>another</span>
<span>thing</span>
<span>i</span>
<span>do</span>
<span>have</span>
<span>documentation</span>
<span>to</span>
<span>prove</span>
<span>my</span>
<span>innocence</span>
</div>

---

# Final fit

We will now use `last_fit()` to **fit** our model one last time on our training data and **evaluate** it on our testing data.


```r
final_fit &lt;- last_fit(
  wf_spec_final, 
  complaints_split
)
```

---

class: inverse, right, middle

# Notice that this is the **first** and **only** time we have used our **testing data**

---

# Evaluate on the **test** data 📐


```r
final_fit %&gt;%
  collect_metrics()
```

```
## # A tibble: 2 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 accuracy binary         0.808
## 2 roc_auc  binary         0.851
```

---


```r
final_fit %&gt;%
  collect_predictions() %&gt;%
  roc_curve(truth = product, .pred_Credit) %&gt;%
  autoplot()
```

&lt;img src="index_files/figure-html/unnamed-chunk-66-1.png" width="700px" style="display: block; margin: auto;" /&gt;

---

class: center, middle

# Thanks!

##[smltar.com](https://smltar.com/)

.pull-left[
&lt;img style="border-radius: 50%;" src="https://github.com/EmilHvitfeldt.png" width="150px"/&gt;  
[<i class="fab  fa-github "></i> @EmilHvitfeldt](https://github.com/EmilHvitfeldt)  
[<i class="fab  fa-twitter "></i> @Emil_Hvitfeldt](https://twitter.com/Emil_Hvitfeldt)  
[<i class="fas  fa-link "></i> hvitfeldt.me](https://www.hvitfeldt.me/)
]

.pull-right[
&lt;img style="border-radius: 50%;" src="https://github.com/juliasilge.png" width="150px"/&gt;  
[<i class="fab  fa-github "></i> @juliasilge](https://github.com/juliasilge)  
[<i class="fab  fa-twitter "></i> @juliasilge](https://twitter.com/juliasilge)  
[<i class="fas  fa-link "></i> juliasilge.com](https://juliasilge.com)
]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="macros.js"></script>
<script>var slideshow = remark.create({
"highlightLanguage": "r",
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
